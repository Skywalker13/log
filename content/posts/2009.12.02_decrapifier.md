---
title: 'Le "decrapifier" de libvalhalla ~ üá´üá∑'
date: 2009-12-02
tags: [geexbox, libvalhalla]
description: "Crap"
draft: false
---

Hello,

sous ce nom barbare se cache un modeste et petit m√©canisme pour nettoyer les
noms des fichiers. Il faut savoir qu'avec des conteneurs audio et vid√©o de bonne
qualit√©, le titre du m√©dia est g√©n√©ralement stock√© dans une m√©ta-donn√©e "title".
En g√©n√©ral ce titre est propre et peut √™tre utilis√© tel quel pour une recherche
d'information sur internet. Dans notre contexte, il est utilis√© en g√©n√©ral par
les "grabbers" pour rechercher les donn√©es, paroles des chansons, descriptions,
liste des acteurs, etc, ‚Ä¶ Malheureusement, on traine encore des boulets au
niveau conteneur multim√©dia.

## Un petit bond en arri√®re

Je me rappel encore tr√®s bien, √† l'√©poque de Windows 3.1 / 3.11 d'avoir install√©
le composant optionnel "Video for Windows". Celui-ci rendait possible la lecture
de petites vid√©os dans des conteneurs AVI (entre autres). J'avais les yeux qui
brillaient quand je voyais ces mini-films d√©filer. Pourtant aujourd'hui on se
plaint quand une vid√©o n'est m√™me pas en 720p. D'un autre c√¥t√© quand on voit le
lecteur Flash qui bouffe toute la puissance CPU avec des vid√©os de mauvaise
qualit√©, y a de quoi se poser des questions par rapport √† ce qui se faisait d√©j√†
il y a 15 ans en arri√®re. Voyez par exemple la vid√©o suivante :

[![](/img/smaky.png)][1]

> Cliquez dessus pour la lire! (si vous le pouvez :-P)

C'est un petit film qui date des alentours de 1997 (peut √™tre m√™me 1996), et qui
est enregistr√© au format [FLI][2]. C'est un format d'animation d'image dans la
m√™me id√©e que le GIF. Ce petit film est cadenc√© √† 14 images/sec avec une
d√©finition d'image de 320√ó200 px. Il peut y avoir √©galement de la compression
avec ce format, mais ce n'est pas aussi sophistiqu√© que du MPEG. L√† o√π je veux
en venir, c'est que cette vid√©o est lisible de mani√®re fluide sur un Smaky 130,
qui correspond √† un processeur Motorola [68030][3] (fix√© √† 25 MHz pour cet
ordinateur). C'est d'un [Smaky][4] que j'ai r√©cup√©r√© ce film √† l'aide d'un outil
que je m'√©tais amus√© √† faire ~~http://home.gna.org/fosfat/~~ (cf.
http://fosfat.schroetersa.ch). La grande partie des logiciels Smaky sont √©crits
en CALM (en calme aussi), qui est une sorte de langage d'abstraction sur les
assembleurs (une notation assembleur ind√©pendante du fabricant). Il y a donc de
forte chance que le Smaky utilise un logiciel √©crit non pas en C/Pascal, mais en
CALM pour arriver √† lire cette animation. Ainsi le Flash me donne vraiment mal
au ventre quand je le vois suer avec un Athlon X2 64.

## Decrapifier

Bref, pour en revenir au "decrapifier", j'ai abord√© les fichiers AVI. Ce
conteneur d√©velopp√© √† l'origine par Microsoft a aujourd'hui des d√©fauts, et
malheureusement on le retrouve encore bien trop souvent (on ne peut pas en
vouloir √† l'AVI, il est vieux). Quoiqu'il en soit, il n'y a pas de m√©ta-donn√©e
"title" la dedans.

Le "decrapifier" va alors se charger d'√©liminer tous les caract√®res peu propice
√† aider √† effectuer des recherches via les "grabbers". A noter √©galement que
lorsqu'un titre est nettoy√©, c'est aussi une bonne chose pour l'utilisateur. Le
principe est tr√®s simple et efficace dans la plupart des cas. Pour l'illustrer,
prenons un nom de fichier inutilisable pour une recherche (et bien trop
courant).

```
"{XvID-LOL}.Elephant.-.Dreams.s02e10_(DVDRip)_Etach.avi"
```

### Etape 1

Le nom est nettoy√© de tous ses caract√®res dont le code ASCII est inclus dans les
7 premiers bits (128 premiers caract√®res). L'ASCII 7 bits √† l'avantage d'√™tre
pr√©sent dans (presque) tous les codages de caract√®res dont l'[unicode][5].
L'id√©e est de simplement remplacer chacun de ces caract√®res par un espace, en
prenant soins de supprimer l'extension du fichier (sauf exception pour
l'apostrophe, les espaces et les caract√®res alpha-num√©riques qui sont
conserv√©s).

```
"XvID LOL Elephant Dreams s02e10 DVDRip Etach"
```

### Etape 2

Une liste noir de mots clefs va permettre d'√©liminer tout ce qui ne nous
int√©resse pas pour la recherche. Les valeurs par d√©faut avec Enna (fichier
`~/.enna/enna.cfg`) sont :

```
0tv, 1080p, 2hd, 720p, ac3, booya, caph, crimson, ctu, dimension, divx, dot,
dsr, dvdrip, dvdscr, e7, etach, fov, fqm, hdq, hdtv, lol, mainevent, notv, pdtv,
proper, pushercrew, repack, reseed, screencam, screener, sys, vtv, x264, xor,
xvid, SExEP, sSEeEP
```

Cette liste est donc √©ditable √† souhait. Il y a deux mots clefs particulier (en
fin de liste) que je vais expliquer dans un deuxi√®me temps. Tous les autres mots
clefs sont √©crits en minuscules car le syst√®me n'est pas sensible aux majuscules
en temps normal. On peut donc voir le r√©sultat sous la forme suivante :

```
" Elephant Dreams s02e10 "
```

### Etape 3

Mais le r√©sultat pr√©c√©dent, bien que beaucoup plus int√©ressant, ne correspond
pas √† la r√©alit√©. Le mot clef `"sSEeEP"` pr√©sent dans la liste va permettre de
g√©rer le `s02e10`. L'id√©e est de r√©cup√©rer √©galement des informations utiles
comme la saison et le num√©ro d'√©pisode. Le vrai r√©sultat est donc :

```
" Elephant Dreams "
```

> Add new metadata "season", value: "2"  
> Add new metadata "episode", value: "10"

### Etape 4

La derni√®re √©tape est de supprimer tous les espaces blancs superflus. Pour
finalement avoir une cha√Æne de caract√®re sous cette forme :

```
"Elephant Dreams"
```

## Les motifs

Deux motifs ont √©t√© pr√©sent√©s bri√®vement. En r√©alit√© il y en a trois.

- `NUM` (indique un nombre non sign√© et entier)
- `SE` (indique un nombre non sign√© et entier qui repr√©sente une saison)
- `EP` (indique un nombre non sign√© et entier qui repr√©sente un √©pisode)

Il y a quelques r√®gles √† prendre en compte lorsqu'on les utilise. Tout d'abord,
ce type de mot clef est sensible aux majuscules. Par exemple, `SSEEEP` n'est pas
√©gale √† `sSEeEP`. Ensuite `NUM`, ne retournant aucune valeur, il peut √™tre
utilis√© plusieurs fois dans un m√™me mot clef.

Prenons l'exemple d'[Elephant Dreams][6]. Si le mot clef √©tait `sNUMeNUM`, le
r√©sultat final serait exactement le m√™me qu'au point 4. N√©anmoins, aucune
nouvelle m√©ta-donn√©e seraient ins√©r√©es. Cela peut donc √™tre utile dans certains
cas de figure o√π on trouverait des num√©ros inutiles. Il ne faut pas non plus
abuser de ce genre de mots clefs. En voulant supprimer tous les num√©ros, on
risquerait de ne plus avoir de titre (je pense au film "2012" par exemple).

Concernant `SE` et `EP`, ils ne doivent √™tre utilis√©s qu'une seule fois par mot
clef. Mais il y a qu'en m√™me quelques libert√©s comme par exemple les mots clefs
suivants sont parfaitement possibles: `SeasonSE`, `EpisodeEP`. Il n'est donc pas
obligatoire d'avoir toujours `SE` et `EP` dans le m√™me mot clef. Une autre
consid√©ration concerne le nombre de saisons et d'√©pisodes pour un seul et m√™me
fichier. Imaginons un autre exemple compl√®tement absurde :

```
"Mes Vacances (02x100) -s55e10-"
```

Si les mots clefs SExEP et sSEeEP sont pr√©sents dans la liste noir, le r√©sultat
final est donc bien:

```
"Mes Vacances"
```

Mais en plus il y a 4 nouvelles m√©ta-donn√©es :

> Add new metadata "season", value: "2"  
> Add new metadata "episode", value: "100"  
> Add new metadata "season", value: "55"  
> Add new metadata "episode", value: "10"

## Pour terminer

Je ne tiens pas √† donner des explications techniques sur le fonctionnement. Le
gros du travail se fait via la magie de `sscanf()`. Le choix de `NUM`, `SE` et
`EP` n'est pas non plus arbitraire. C'est uniquement par souci de commodit√©. En
interne, le `NUM` est remplac√© par `%*u`, les `SE` et `EP` sont remplac√©s par
`%u`. Cela √©vite de devoir jouer l'accord√©on avec les cha√Ænes de caract√®res.
Pour des d√©tails, lisez le MAN de `sscanf`.

A bient√¥t,  
Mathieu SCHROETER

[1]: /movie/smaky.fli
[2]: http://en.wikipedia.org/wiki/FLIC_%28file_format%29
[3]: http://en.wikipedia.org/wiki/68030
[4]: http://fr.wikipedia.org/wiki/Smaky
[5]: http://en.wikipedia.org/wiki/Unicode
[6]: http://www.elephantsdream.org/
